// âœ… Replit Backend Setup â€“ ConvertWiz Premium Foundation
// Includes: Admin Dashboard Fix, Percentage Calculator, Firestore Rules

import express from 'express';
import bodyParser from 'body-parser';
import admin from 'firebase-admin';
import serviceAccount from './firebase-service-account.json' assert { type: 'json' };
import fs from 'fs';

const app = express();
app.use(bodyParser.json());

// Initialize Firebase Admin SDK
if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}
const db = admin.firestore();

// âœ… Admin Whitelist
const adminEmails = [
  'iqbalaiwork@gmail.com',
  'iqbalbashasi@gmail.com',
  'sajoshaikh@gmail.com',
  'support@convertwiz.in'
];

// âœ… Admin Dashboard Route Fix
app.get('/admin', async (req, res) => {
  const email = req.query.email; // Pass email as query param for now
  if (!adminEmails.includes(email)) {
    return res.status(403).send('Access Denied');
  }

  const usersSnapshot = await db.collection('users').get();
  const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  res.json(users);
});

// âœ… Percentage Calculator Endpoint (Logic Only)
app.post('/api/percentage-calculator', (req, res) => {
  const { value, percentage } = req.body;
  if (isNaN(value) || isNaN(percentage)) {
    return res.status(400).json({ error: 'Invalid input' });
  }
  const result = (value * percentage) / 100;
  res.json({ result, message: `${percentage}% of ${value} is ${result}` });
});

// âœ… Firestore Rules (for reference)
/*
match /tools/{toolId} {
  allow read: if request.auth != null &&
    get(/databases/(default)/documents/users/$(request.auth.uid)).data.userType == "premium";
}
*/

// âœ… Success Page Stub
app.get('/success', (req, res) => {
  res.send("ðŸŽ‰ Thank you for subscribing to ConvertWiz Premium!");
});

// âœ… Cancel Page Stub
app.get('/cancel', (req, res) => {
  res.send("âŒ Subscription cancelled or not completed.");
});

// âœ… Run Server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`ConvertWiz backend running on port ${PORT}`));
